angular.module("dietitian").controller("todayNutritionCtl",function($scope,$log,socket,state){function drawTodayNutrition(nutrition){var ctx=document.getElementById("today-nutrition-chart"),options={scale:{ticks:{stepSize:25,beginAtZero:!0,max:100}}},data={labels:["炭水化物","たんぱく質","脂肪","食物繊維"],datasets:[{data:[Math.round(100*nutrition.carb/state.person.requiredNutrition.carb),Math.round(100*nutrition.protein/state.person.requiredNutrition.protein),Math.round(100*nutrition.fat/state.person.requiredNutrition.fat),Math.round(100*nutrition.fiber/state.person.requiredNutrition.fiber)],backgroundColor:["#FF6384","#4BC0C0","#FFCE56","#E7E9ED","#36A2EB"],label:"My dataset"}]};$scope.ui.todayNutritionChart&&$scope.ui.todayNutritionChart.destroy(),$scope.ui.todayNutritionChart=new Chart(ctx,{type:"polarArea",data:data,options:options})}function registerIoEvent(connection){connection.on("personalHistoryUpdated",function(dietList){$scope.$apply(function(){processDietList(dietList)})})}function processDietList(dietList){angular.forEach(dietList,function(diet,dietKey){$scope.ui.todayNutrition.carb+=diet.carb||0,$scope.ui.todayNutrition.protein+=diet.protein||0,$scope.ui.todayNutrition.fat+=diet.fat||0,$scope.ui.todayNutrition.fiber+=diet.fiber||0}),state.reloadTodayNutritionChart()}$scope.state=state,$scope.ui={},$scope.ui.todayNutrition={carb:0,protein:0,fat:0,fiber:0},$scope.$watch("state.requestReloadTodayNutritionChart",function(newVal,oldVal){newVal!=oldVal&&drawTodayNutrition($scope.ui.todayNutrition)}),$scope.$watch("state.person.requiredNutrition",function(newVal,oldVal){newVal!==oldVal&&state.reloadTodayNutritionChart()}),$scope.$watch("state.todayDietList",function(newVal,oldVal){newVal!=oldVal&&processDietList(newVal)}),registerIoEvent(socket.connection)});
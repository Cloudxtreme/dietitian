angular.module("dietitian").controller("todayCalorieCtl",function($scope,$log,socket,state){function drawTodayCalorie(requiredCalorie,todayCalorie){var ctx=document.getElementById("today-calorie-chart"),options={responsive:!1};todayCalorie>requiredCalorie&&(requiredCalorie=todayCalorie);var data={labels:["摂取済み","残り"],datasets:[{data:[todayCalorie,requiredCalorie-todayCalorie],backgroundColor:["#FF6384","#DDDDDD"]}]};$scope.ui.todayCalorieChart&&$scope.ui.todayCalorieChart.destroy(),$scope.ui.todayCalorieChart=new Chart(ctx,{type:"doughnut",data:data,options:options})}function processDietList(dietList){angular.forEach(dietList,function(diet,dietKey){$scope.ui.todayCalorie+=diet.calorie||0}),state.reloadTodayCalorieChart()}$scope.state=state,$scope.ui={},$scope.ui.todayCalorie=0,$scope.ui.todayCaloriePercentage=0,$scope.ui.todayCalorieToGo=0,$scope.$watch("state.requestReloadTodayCalorieChart",function(newVal,oldVal){newVal!=oldVal&&($scope.ui.todayCaloriePercentage=Math.round(100*$scope.ui.todayCalorie/state.person.requiredCalorie),$scope.ui.todayCalorieToGo=state.person.requiredCalorie-$scope.ui.todayCalorie,drawTodayCalorie(state.person.requiredCalorie,$scope.ui.todayCalorie))}),$scope.$watch("state.person.requiredCalorie",function(newVal,oldVal){newVal!=oldVal&&state.reloadTodayCalorieChart()}),$scope.$watch("state.todayDietList",function(newVal,oldVal){newVal!=oldVal&&processDietList(newVal)}),function(connection){connection.on("personalHistoryUpdated",function(dietList){$scope.$apply(function(){processDietList(dietList)})})}(socket.connection)});
angular.module("dietitian").controller("todayCtl",function($scope,$log,socket,state,personalHistoryDb){function drawTodayNutrition(nutrition){var ctx=document.getElementById("today-nutrition-chart"),options={scale:{ticks:{stepSize:25,beginAtZero:!0,max:100}}},data={labels:["炭水化物","たんぱく質","脂肪","食物繊維"],datasets:[{data:[Math.round(100*nutrition.carb/state.person.requiredNutrition.carb),Math.round(100*nutrition.protein/state.person.requiredNutrition.protein),Math.round(100*nutrition.fat/state.person.requiredNutrition.fat),Math.round(100*nutrition.fiber/state.person.requiredNutrition.fiber)],backgroundColor:["#FF6384","#4BC0C0","#FFCE56","#E7E9ED","#36A2EB"],label:"My dataset"}]};$scope.ui.todayNutritionChart&&$scope.ui.todayNutritionChart.destroy(),$scope.ui.todayNutritionChart=new Chart(ctx,{type:"polarArea",data:data,options:options})}function drawTodayCalorie(requiredCalorie,todayCalorie){var ctx=document.getElementById("today-calorie-chart"),options={responsive:!1};todayCalorie>requiredCalorie&&(requiredCalorie=todayCalorie);var data={labels:["摂取済み","残り"],datasets:[{data:[todayCalorie,requiredCalorie-todayCalorie],backgroundColor:["#FF6384","#DDDDDD"]}]};$scope.ui.todayCalorieChart&&$scope.ui.todayCalorieChart.destroy(),$scope.ui.todayCalorieChart=new Chart(ctx,{type:"doughnut",data:data,options:options})}function processDietList(dietList){angular.forEach(dietList,function(diet,dietKey){$scope.ui.dietListByType[diet.diet_type].push(diet),$scope.ui.todayCalorie+=diet.calorie||0,$scope.ui.todayNutrition.carb+=diet.carb||0,$scope.ui.todayNutrition.protein+=diet.protein||0,$scope.ui.todayNutrition.fat+=diet.fat||0,$scope.ui.todayNutrition.fiber+=diet.fiber||0}),$scope.reloadTodayCalorieChart(),$scope.reloadTodayNutritionChart()}$scope.state=state,$scope.ui={},$scope.ui.todayCalorie=0,$scope.ui.todayCaloriePercentage=0,$scope.ui.todayCalorieToGo=0,$scope.ui.todayNutrition={carb:0,protein:0,fat:0,fiber:0},$scope.ui.dietListByType={breakfast:[],lunch:[],dinner:[]},$scope.ui.reloadTodayCalorieChart=1,$scope.ui.reloadTodayNutritionChart=1,$scope.reloadTodayCalorieChart=function(){$scope.ui.reloadTodayCalorieChart=-1*$scope.ui.reloadTodayCalorieChart},$scope.reloadTodayNutritionChart=function(){$scope.ui.reloadTodayNutritionChart=-1*$scope.ui.reloadTodayNutritionChart},$scope.$watch("ui.reloadTodayCalorieChart",function(newVal,oldVal){newVal!=oldVal&&($scope.ui.todayCaloriePercentage=Math.round(100*$scope.ui.todayCalorie/state.person.requiredCalorie),$scope.ui.todayCalorieToGo=state.person.requiredCalorie-$scope.ui.todayCalorie,drawTodayCalorie(state.person.requiredCalorie,$scope.ui.todayCalorie))}),$scope.$watch("ui.reloadTodayNutritionChart",function(newVal,oldVal){newVal!=oldVal&&drawTodayNutrition($scope.ui.todayNutrition)}),$scope.$watch("state.person.requiredCalorie",function(newVal,oldVal){newVal!=oldVal&&$scope.reloadTodayCalorieChart()}),$scope.$watch("state.person.requiredNutrition",function(newVal,oldVal){newVal!==oldVal&&$scope.reloadTodayNutritionChart()}),personalHistoryDb.getTodayHistory().then(function(response){processDietList(response.data)},function(error){$log.error(error)}),function(connection){connection.on("personalHistoryUpdated",function(dietList){$scope.$apply(function(){processDietList(dietList)})})}(socket.connection)}).directive("todayDietReportByType",function($compile){return{restrict:"E",templateUrl:"todayDietReportByType",scope:{dietTypeLabel:"@",dietList:"="}}}).directive("todayDietReportByTypeMobile",function($compile){return{restrict:"E",templateUrl:"todayDietReportByTypeMobile",scope:{dietTypeLabel:"@",dietList:"="}}});